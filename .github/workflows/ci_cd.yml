name: CI + CD (main)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build-test-and-deploy:
    runs-on: ubuntu-latest

    env:
      PYTHON_VERSION: "3.11"

    steps:
      # 0) Checkout del repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 1) Setup Python
      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # 2) Instalar dependencias
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 3) PREPROCESAMIENTO
      - name: Preprocesamiento de datos
        run: |
          python -m src.data_prep

      # 4) ENTRENAMIENTO
      - name: Entrenamiento del modelo
        run: |
          python -m src.train

      # 5) EVALUACIÓN
      - name: Evaluación del modelo
        run: |
          python -m src.evaluate

      # 6) TESTS (CI clásico)
      - name: Run tests (pytest)
        env:
          PYTHONPATH: ${{ github.workspace }}
        run: |
          python -m pytest -q

      # 7) DEPLOY a Hugging Face Spaces (simulación de "producción")
      - name: Deploy to Hugging Face Space
        if: success()
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_SPACE_ID: ${{ secrets.HF_SPACE_ID }}
        run: |
          echo "Clonando Space $HF_SPACE_ID..."
          git clone https://huggingface.co/spaces/$HF_SPACE_ID space_repo

          echo "Sincronizando código del repo al Space..."
          rsync -av --delete ./ space_repo/ \
            --exclude ".git" \
            --exclude ".github" \
            --exclude "space_repo" \
            --exclude "data" \
            --exclude "mlruns" \
            --exclude ".dvc" \
            --exclude "__pycache__" \

          cd space_repo

          echo "Configurando remote con token..."
          # 'user' puede ser cualquiera, Hugging Face usa el token para autenticar
          git remote set-url origin https://user:$HF_TOKEN@huggingface.co/spaces/$HF_SPACE_ID

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A
          git commit -m "deploy: sync from GitHub main" || echo "No hay cambios para commitear"

          echo "Haciendo push al Space..."
          git push origin HEAD

